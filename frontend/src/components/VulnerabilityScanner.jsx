import React, { useState } from 'react';
import { scannerAPI, chatAPI } from '../services/api';
import '../styles/VulnerabilityScanner.css';

export default function VulnerabilityScanner() {
  const [input, setInput] = useState('');
  const [results, setResults] = useState(null);
  const [remediation, setRemediation] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleScan = async () => {
    if (!input.trim()) {
      setError('Please enter a URL or file path to scan');
      return;
    }

    setLoading(true);
    setError('');
    setResults(null);
    setRemediation(null);

    try {
      const response = await scannerAPI.scanVulnerabilities(input);
      setResults(response.data);

      // Get remediation advice from Chatbot
      if (response.data.vulnerabilities && response.data.vulnerabilities.length > 0) {
        try {
            const chatResponse = await chatAPI.remediate(response.data);
            setRemediation(chatResponse.data);
        } catch (chatErr) {
            console.error("Failed to get remediation", chatErr);
        }
      }

    } catch (err) {
      setError(err.response?.data?.error || 'Scan failed');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="scanner-container">
      <h2>ğŸ” Vulnerability Scanner</h2>
      <p>Scan URLs, source code files, or package.json for potential security vulnerabilities</p>

      <div className="input-group">
        <input
          type="text"
          placeholder="Enter URL (http://...) or absolute file path"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && handleScan()}
        />
        <button onClick={handleScan} disabled={loading} className="btn-primary">
          {loading ? 'Scanning...' : 'Scan'}
        </button>
      </div>

      {error && <div className="error-message">{error}</div>}

      {results && (
        <div className="results">
          <div className="scan-meta">
             <span className="scan-type">Type: {results.type === 'dependency_scan' ? 'ğŸ“¦ Dependency Scan' : results.type === 'project_scan' ? 'ğŸ“‚ Project Scan' : results.type === 'url' ? 'ğŸŒ URL Scan' : 'ğŸ“„ File Scan'}</span>
             <span className={`risk-badge ${results.riskLevel?.toLowerCase()}`}>
               {results.isSafe ? 'âœ… SAFE' : `âš ï¸ ${results.riskLevel}`}
             </span>
          </div>

          {results.vulnerabilities && results.vulnerabilities.length > 0 ? (
            <div className="vulnerabilities">
              <h3>Found {results.vulnerabilities.length} Issue(s)</h3>
              {results.vulnerabilities.map((vuln, idx) => (
                <div key={idx} className={`vuln-item ${vuln.severity}`}>
                  <div className="vuln-header">
                    <strong>{vuln.type}</strong>
                    <span className="severity-badge">{vuln.severity}</span>
                  </div>
                  <p>{vuln.description}</p>
                </div>
              ))}

              {remediation && remediation.remediation && (
                  <div className="remediation-section">
                      <h3>ğŸ¤– Chatbot Remediation Advice</h3>
                      {remediation.remediation.map((item, idx) => (
                          <div key={idx} className="remediation-card">
                              <h4>How to Fix: {item.topic}</h4>
                              <p>{item.message}</p>
                              {item.prevention && (
                                  <ul>
                                      {item.prevention.map((prev, pIdx) => (
                                          <li key={pIdx}>{prev}</li>
                                      ))}
                                  </ul>
                              )}
                              {item.examples && item.examples.length > 0 && (
                                  <div className="code-examples">
                                      <h5>Examples:</h5>
                                      {item.examples.map((ex, eIdx) => (
                                          <code key={eIdx}>{ex}</code>
                                      ))}
                                  </div>
                              )}
                          </div>
                      ))}
                  </div>
              )}

            </div>
          ) : (
            <div className="success-message">
              <h3>No vulnerabilities detected!</h3>
              <p>Your {results.type === 'url' ? 'URL' : 'file'} appears safe based on our scan patterns.</p>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
